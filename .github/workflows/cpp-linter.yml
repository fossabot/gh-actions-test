name: 'C/C++ Lint'

on:
  pull_request:
    types: [opened, reopened]  # let PR-synchronize events be handled by push events
  push:
  workflow_dispatch:

jobs:
  cpp-linter:
    runs-on: ubuntu-24.04
    steps:
    - name: Install basic dependencies
      run: |
        sudo apt-get update
        sudo apt-get install --no-install-recommends -y cmake ninja-build ccache clang clang-tools

    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Conan package manager
      run: |
        pip --disable-pip-version-check --no-cache-dir install wheel conan

    - name: Cache Conan2' dependencies
      id: conan2-cache
      uses: actions/cache@v4
      with:
        key: ${{ runner.os }}-conan-${{ hashFiles('conanfile.txt') }}
        path: |
          ~/.conan2
          build/conan

    - if: ${{ steps.conan2-cache.outputs.cache-hit != 'true' }}
      name: Check the state of installed dependencies by Conan2
      # no build required for linting
      run: |
        conan profile detect --force --name default
        conan install . --settings=compiler.cppstd=17 -s build_type=Release --output-folder build/conan

    - name: CMake configuration
      run: |
        cmake --preset ci-linux-clang

    - name: Run cpp-linter (clang format && tidy)
      id: linter
      uses: cpp-linter/cpp-linter-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        style: 'file'  # Use .clang-format config file
        tidy-checks: '' # Use .clang-tidy config file
        database: build/ci-linux-clang
        # only 'update' a single comment in a pull request thread.
        thread-comments: ${{ github.event_name == 'pull_request' && 'update' }}

    - name: Check for passed C++ style
      if: steps.linter.outputs.checks-failed > 0
      run: |
        echo "Some files failed the Clang tidy/format checks!"
